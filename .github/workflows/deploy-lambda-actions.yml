name: Deploy Photo Processing Lambda (Using GitHub Actions)

on:
  push:
    branches: [ main ]
    paths-ignore: 
      - '**.md'
      - 'test-local.sh'
  workflow_dispatch:

env:
  LAMBDA_FUNCTION_NAME: ${{ secrets.LAMBDA_FUNCTION_NAME || 'phot3s-upload-lambda' }}
  AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-1' }}
  # Environment variables from GitHub Variables (non-sensitive)
  ALLOWED_SOURCE_BUCKETS: ${{ vars.ALLOWED_SOURCE_BUCKETS }}
  PROCESSED_BUCKET: ${{ vars.PROCESSED_BUCKET }}
  PROCESSED_PREFIX: ${{ vars.PROCESSED_PREFIX || 'processed/' }}
  DELETE_ORIGINAL: ${{ vars.DELETE_ORIGINAL || 'true' }}
  CHECK_DUPLICATES: ${{ vars.CHECK_DUPLICATES || 'true' }}
  DUPLICATE_ACTION: ${{ vars.DUPLICATE_ACTION || 'move' }}
  DUPLICATES_PREFIX: ${{ vars.DUPLICATES_PREFIX || 'duplicates/' }}

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run tests (if any)
      run: npm test --if-present

    - name: Validate Lambda function syntax
      run: node -c upload-lambda.js

  deploy:
    needs: test
    runs-on: ubuntu-latest
    outputs:
      function-name: ${{ env.LAMBDA_FUNCTION_NAME }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Validate required secrets
      run: |
        if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ] || [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
          echo "‚ùå Error: AWS credentials not configured"
          echo "Please set AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY in repository secrets"
          exit 1
        fi
        echo "‚úÖ AWS credentials are configured"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # Use SAM CLI for Lambda deployment - more robust than manual steps
    - name: Setup AWS SAM CLI
      uses: aws-actions/setup-sam@v2

    - name: Create SAM template
      run: |
        # Build environment variables dynamically, excluding empty/null values
        echo "Building environment variables for Lambda..."
        ENV_VARS=""
        
        # Always include required variables
        ENV_VARS="${ENV_VARS}                  SKIP_PROCESSED_FOLDER: \"true\"\n"
        ENV_VARS="${ENV_VARS}                  PROCESSED_PREFIX: \"${{ env.PROCESSED_PREFIX }}\"\n"
        ENV_VARS="${ENV_VARS}                  DELETE_ORIGINAL: \"${{ env.DELETE_ORIGINAL }}\"\n"
        ENV_VARS="${ENV_VARS}                  CHECK_DUPLICATES: \"${{ env.CHECK_DUPLICATES }}\"\n"
        ENV_VARS="${ENV_VARS}                  DUPLICATE_ACTION: \"${{ env.DUPLICATE_ACTION }}\"\n"
        ENV_VARS="${ENV_VARS}                  DUPLICATES_PREFIX: \"${{ env.DUPLICATES_PREFIX }}\"\n"
        
        # Only include optional variables if they're not empty
        if [ -n "${{ env.ALLOWED_SOURCE_BUCKETS }}" ]; then
          echo "‚úÖ Including ALLOWED_SOURCE_BUCKETS: ${{ env.ALLOWED_SOURCE_BUCKETS }}"
          ENV_VARS="${ENV_VARS}                  ALLOWED_SOURCE_BUCKETS: \"${{ env.ALLOWED_SOURCE_BUCKETS }}\"\n"
        else
          echo "‚ö†Ô∏è  ALLOWED_SOURCE_BUCKETS not set - Lambda will allow any source bucket"
        fi
        
        if [ -n "${{ env.PROCESSED_BUCKET }}" ]; then
          echo "‚úÖ Including PROCESSED_BUCKET: ${{ env.PROCESSED_BUCKET }}"
          ENV_VARS="${ENV_VARS}                  PROCESSED_BUCKET: \"${{ env.PROCESSED_BUCKET }}\"\n"
        else
          echo "‚ÑπÔ∏è  PROCESSED_BUCKET not set - will use same bucket as source"
        fi
        
        echo "üìÑ Creating SAM template with dynamic environment variables..."
        cat > template.yaml << EOF
        AWSTemplateFormatVersion: '2010-09-09'
        Transform: AWS::Serverless-2016-10-31
        Description: Photo Processing Lambda Function

        Resources:
          PhotoProcessingFunction:
            Type: AWS::Serverless::Function
            Properties:
              FunctionName: ${{ env.LAMBDA_FUNCTION_NAME }}
              Runtime: nodejs20.x
              Handler: upload-lambda.handler
              CodeUri: .
              MemorySize: 512
              Timeout: 60
              Environment:
                Variables:
        $(echo -e "$ENV_VARS")
              Policies:
                - S3FullAccessPolicy:
                    BucketName: "*"
                - CloudWatchLogsFullAccess

        Outputs:
          PhotoProcessingFunctionArn:
            Description: "Photo Processing Lambda Function ARN"
            Value: !GetAtt PhotoProcessingFunction.Arn
        EOF
        
        echo "üìÑ Generated SAM template:"
        cat template.yaml

    - name: Deploy with SAM
      run: |
        # Disable SAM CLI telemetry for CI/CD
        export SAM_CLI_TELEMETRY=0
        
        sam deploy \
          --no-confirm-changeset \
          --no-fail-on-empty-changeset \
          --stack-name photo-processing-lambda \
          --capabilities CAPABILITY_IAM \
          --region ${{ env.AWS_REGION }} \
          --resolve-s3

    - name: Verify deployment
      run: |
        echo "üîç Verifying deployment..."
        aws lambda get-function \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --query 'Configuration.{FunctionName:FunctionName,State:State,Runtime:Runtime,MemorySize:MemorySize}' \
          --output table
        
        echo ""
        echo "üìã Environment variables:"
        aws lambda get-function-configuration \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --query 'Environment.Variables' \
          --output table

    - name: Test function invocation
      run: |
        echo "üß™ Testing Lambda function with empty event..."
        # Create a proper empty S3 event payload
        echo '{"Records":[]}' > test-event.json
        
        aws lambda invoke \
          --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
          --payload file://test-event.json \
          --cli-read-timeout 30 \
          response.json
        
        echo "Function response:"
        cat response.json
        echo ""
        
        # Clean up test files
        rm -f test-event.json response.json

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Notify deployment result
      run: |
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "üéâ DEPLOYMENT SUCCESSFUL!"
          echo "=============================="
          echo "Your photo processing Lambda is now deployed and ready to use."
          echo ""
          echo "üìã What was deployed:"
          echo "   ‚Ä¢ Lambda Function: ${{ needs.deploy.outputs.function-name }}"
          echo "   ‚Ä¢ Runtime: Node.js 20.x with sharp, exif-parser libraries"
          echo "   ‚Ä¢ Memory: 512MB, Timeout: 60 seconds"
          echo "   ‚Ä¢ IAM Role: Automatically created by SAM"
          echo ""
          echo "üöÄ Next Steps:"
          echo "   1. Configure S3 bucket triggers via AWS Console"
          echo "   2. Upload test photos to trigger processing"
          echo "   3. Check CloudWatch logs for processing results"
          echo ""
          echo "üìö Documentation:"
          echo "   ‚Ä¢ Multi-bucket setup: See MULTI_BUCKET.md"
          echo "   ‚Ä¢ S3 trigger setup: See README.md"
          echo "   ‚Ä¢ Troubleshooting: Check CloudWatch logs at /aws/lambda/${{ needs.deploy.outputs.function-name }}"
        else
          echo "‚ùå DEPLOYMENT FAILED"
          echo "==================="
          echo "Check the logs above for details."
          echo "Common issues:"
          echo "   ‚Ä¢ AWS credentials not configured"
          echo "   ‚Ä¢ Insufficient IAM permissions"
          echo "   ‚Ä¢ Function name already exists"
          exit 1
        fi